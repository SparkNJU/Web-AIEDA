# 工具调用和引用标签折叠功能测试说明

## 功能概述

实现了AI回复中工具调用和引用标签的折叠显示功能，主要包括：

### 后端改进 (ChatServiceImpl.java)

1. **实时流式处理**：
   - 不再等待完整的`<finish>`标签才开始发送内容
   - 当遇到`<`时，等待完整标签出现
   - 过滤`<finish>`和`</finish>`标签，保留其他标签
   - 实时发送处理后的内容到前端

2. **标签处理逻辑**：
   - `processAndFilterDelta()`: 处理并过滤delta内容
   - `findCompleteTag()`: 寻找完整标签的结束位置
   - 支持引号内的属性值，避免误解析

### 前端改进 (MessageBubble.vue)

1. **多种工具调用格式支持**：
   - 支持代码块格式：```tool\n内容\n```
   - 支持XML格式：`<tool_name>内容</tool_name>`
   - 自动识别工具名称

2. **引用标签处理**：
   - 支持任意标签名（不限于mcreference）
   - 按顺序生成ref_id（ref_1, ref_2, ...）
   - 显示原始标签名称

3. **折叠显示**：
   - 工具调用默认折叠，绿色左边框
   - 引用链接默认折叠，蓝色左边框
   - 支持垂直调整大小和滚动

## 测试用例

### 1. 工具调用测试
输入包含：
```
```tool
调用`mcp_client`
operation: call_tool, arguments: {'query': '王力宏'}, tool_name: bing_search
```
```

期望显示：
- 主内容：`[🔧 工具调用: mcp_client]`
- 折叠区域：显示完整工具调用信息

### 2. 引用标签测试
输入包含：
```html
<mcreference link="https://example.com" index="1">参考资料</mcreference>
```

期望显示：
- 主内容：`[📚 mcreference_1]`
- 折叠区域：`📚 mcreference [ref_1]: 参考资料`

### 3. 混合内容测试
输入包含工具调用、引用和普通文本，验证：
- 所有标签正确识别和处理
- ref_id按顺序递增
- 折叠功能正常工作

## 技术特点

1. **性能优化**：
   - 流式输出时使用文本渲染，完成后切换markdown
   - 防抖滚动，避免频繁操作
   - 智能标签解析，避免误匹配

2. **用户体验**：
   - 清晰的视觉标识（emoji + 颜色）
   - 可调整大小的内容区域
   - 平滑的展开/折叠动画

3. **扩展性**：
   - 支持任意标签名
   - 易于添加新的工具类型
   - 模块化的处理逻辑
